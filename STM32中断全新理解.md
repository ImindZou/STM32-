# STM32中断全新理解

[TOC]

> 每日一句：**接受失败，但不接受放弃。**
>
> **Accept failure, but don't accept giving up.**

![img](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310080905575.gif)

# EXTI

根据对启动文件的分析，我们知道中断来自启动文件中的中断向量表，在开启了中断之后，当系统发生异常，就会跳到中断向量表中查询相应的中断向量表，找到对应的编号，对准该接口进行初始化。

![image-20231008092727814](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310080927865.png)

中断向量表中的中断函数入口都是弱定义的，如果我们不去有意地修改它，他就是按系统默认执行的，即我们平常写的一些不带中断功能的工程，它其实系统已经默认为它配置了一些必要的中断。

![image-20231008092646195](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310080926253.png)

例如异常复位中断，在我们触发系统复位的那一刻，系统就直接重默认的FLASH复位，在复位后寄存器的该寄存器的值为0，因此在地址0必须包含一张中断向量表，用于初始化异常分配。

![image-20231007213005237](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310080924240.png)

也就是说我们可以根据需要对中断函数进行相应的配置，配置完后系统会按照我们的所配置的中断进行运行，也就是不会运行默认中断了。

![image-20231008093340217](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310080933264.png)

![image-20231008093243267](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310080932328.png)

__HAL_GPIO_EXTI_GET_IT（）原型，以及结合寄存器说明：

![image-20231008093731296](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310080937352.png)

# NVIC

> **概念：NVIC是嵌套向量中断控制器，控制着整个芯片中断相关的功能，它和内核紧密耦合，是一个内核里边的外设。但是各芯片厂商在设计芯片的时候会对Cortex-M3内核里面的NVIC进行裁剪，把不需要的部分去掉，所以说STM32的NVIC是COrtex-M3的一个子集。**

## 优先级的定义

在NVIC 有一个专门的寄存器：中断优先级寄存器NVIC_IPRx，用来配置外部中断的优先级，IPR
宽度为8bit，原则上每个外部中断可配置的优先级为0~255，数值越小，优先级越高。但是绝大
多数CM3 芯片都会精简设计，以致实际上支持的优先级数减少，在F103 中，只使用了高4bit，
如下所示：

![image-20231008095317928](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310080953988.png)

用于表达优先级的这4bit，又被分组成抢占优先级和子优先级。如果有多个中断同时响应，抢占
优先级高的就会抢占抢占优先级低的优先得到执行，如果抢占优先级相同，就比较子优先级。如
果抢占优先级和子优先级都相同的话，就比较他们的硬件中断编号，编号越小，优先级越高。

## 优先级分组

优先级的分组由内核外设SCB 的应用程序中断及复位控制寄存器AIRCR 的PRIGROUP[10:8] 位
决定，F103 分为了5 组，具体如下：主优先级= 抢占优先级

![image-20231008095432896](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310080954935.png)

设置优先级分组可调用库函数HAL_NVIC_SetPriority() 实现，有关NVIC 中断相关的库函数都在
库文件stm32f1xx_hal_cortex.c 和stm32f1xx_hal_cortex.h 中。

![image-20231008095628565](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310080956604.png)

# 中断编程

在配置完每个中断的时候一般有3个编程要点：

1. 使能外设某个中断，这个具体由每个外设的相关中断使能位控制。比如串口由发送完成跟接收完成的中断，这两个中带你都由串口控制寄存器的相关中断使能控制。
2. 配置EXTI中断源、配置中断优先级。

![image-20231008100355890](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310081003943.png)

1. IRQn：用来设置中断源，不同的中断源不一样，且不可写错，即使写错了程序也不会报错，只会导致中断不响应。具体的成员配置可参考stm32f103xe.h 头文件里面的IRQn_Type 结构
    体定义，这个结构体包含了所有的中断源。如下图：
    - ![image-20231008100721422](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310081007472.png)
2. PreemptionPriority：抢占优先级，具体的值要根据优先级分组来确定。
3. SubPriority：子优先级，具体的值要根据优先级分组来确定。

![image-20231008101524776](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310081015835.png)

## 编写中断服务函数

启动文件中前面提过，里边预先位每个中断都编写了一个中断服务函数，只是这些函数都是为空，位的只是初始化中断向量表。实际上的中断服务函数都需要我们重新编写，为了方便管理我们把中断服务函数统一放到stm32f1xx_it.c这个库文件中。

关于中带您服务函数的函数名必须跟启动文件里边预设的一样，如果写错，系统就在中断向量表找不到中断服务函数的入口，直接跳转到默认函数，并且在里边无限循环，实现不了中断。

> 抽象一下就是这样
>
> ![image-20231008103311708](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310081033770.png)

> **学会了只是一种错觉，只有自己迈出实践的那一步才知道自己明白没有，人生三大错觉之一，我学会了。**