# MCU独立看门狗与窗口看门狗的区别

早期的MCU没有看门狗，就容易引起有些产品死机了不能重启工作。为了避免这个问题，后期的MCU在内部集成了看门狗的功能。

为了满足更多使用场景，现在很多MCU都集成了两个看门狗：[**独立看门狗与窗口看门狗**](http://mp.weixin.qq.com/s?__biz=MzI4MDI4MDE5Ng%3D%3D&chksm=ebb852f5dccfdbe3e1457f1f23eb87cfbe88795c5644a4d793a51a10f5d9eafd77f52a8c0187&idx=1&mid=2247499550&scene=21&sn=3d02459e8c648d83c02586537cc91f22#wechat_redirect)。

拿现在大家熟悉的STM32来说，都集成了独立看门狗和窗口看门狗，下面就展开来讲讲这个两个看门狗以及它们的区别。

**独立看门狗**

独立看门狗，顾名思义，就是独立的一个看门狗，由其专用低速时钟 (LSI) 驱动，因此，**即便在主时钟发生故障时仍然保持工作状态。**

IWDG 最适合应用于那些需要看门狗作为一个在主程序之外，能够完全独立工作，并且对时间精度要求较低的场合。 

**独立看门狗特性：**

- 自由运行递减计数器
- 时钟由独立 RC 振荡器提供（可在待机和停止模式下运行）
- 当递减计数器值达到 0x000 时产生复位（如果看门狗已激活）

![img](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310310947890.png)

**窗口看门狗**

窗口看门狗，之所以称为窗口，是因为其喂狗时间是一个有上下限的范围内，你可以通过设定相关寄存器，设定其上限时间和下限时间：**喂狗的时间不能过早也不能过晚。**

![img](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310310947894.jpeg)

窗口型看门狗

窗口看门狗的上窗口就是配置寄存器WWDG->CFR里设定的W[6:0]；下窗口是固定的0x40；当窗口看门狗的计数器在上窗口值之外，或是低于下窗口值都会产生复位。

![img](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310310947897.jpeg)

窗口型看门

狗工作原理

上窗口的值可以只有设定，7位二进制数最大只可以设定为127(0x7F)，最小又必须大于下窗口的0x40，所以其取值范围为64~127(即：0x40~0x7F)；配置寄存器WWDG->CFR中为计数器设定时钟分频系数，确定这个计数器可以定时的时间范围，从而确定窗口的时间范围。

窗口看门狗的时钟来自于PCLK1，在时钟配置中，其频率为外部时钟经倍频器后的二分频时钟，即为36MHz，根据手册可以知道其定时时间计算方法：

![img](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310310947904.jpeg)

**两者对比**

**1.使用条件对比**

![img](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310310947880.jpeg)

**2.特点对比**

![img](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310310947907.jpeg)

**两者的区别**

独立看门狗与窗口看门狗的区别如下：

- 独立看门狗没有[中断](https://so.csdn.net/so/search?q=中断&spm=1001.2101.3001.7020)，窗口看门狗有中断。

- 独立看门狗有硬件软件之分，窗口看门狗只能软件控制。
- 独立看门狗只有下限，窗口看门狗有下限和上限。
- 独立看门狗是12位递减的，窗口看门狗是7位递减的。
- 独立看门狗是用的内部大约40KHz的RC振荡器，窗口看门狗是用的系统时钟APB1ENR

独立看门狗没有中断功能，只要在计数器减到0(下限)之前，重新装载计数器的值，就不会产生复位。

[**要注意看门狗和外接复位IC同时存在的情况**](http://mp.weixin.qq.com/s?__biz=MzI4MDI4MDE5Ng%3D%3D&chksm=ebb852f5dccfdbe3e1457f1f23eb87cfbe88795c5644a4d793a51a10f5d9eafd77f52a8c0187&idx=1&mid=2247499550&scene=21&sn=3d02459e8c648d83c02586537cc91f22#wechat_redirect)，外部电路可能会阻止看门狗复位。

窗口看门狗有中断，这个中断的作用是在计数器达到下限0x40的时候，产生中断，让你喂狗；如果你不喂狗，计数器的值变为0x3f的时候，将会产生系统复位；即使是喂狗，也应该在中断里快速喂狗，要不时间长了计数器减1也会变成0x3f产生复位。

窗口看门狗还有一个上限值，这个值如果大于计数器的初始值，那么就没有任何作用了；这个值小于计数器初始值的时候，当计数器的值大于上限值时你对计数器进行装载，将会产生复位，只有在计数器减到小于上限值时，你才能重新装载计数器。意思就是说只有计数器的值在上限值和下限值之间你才能装载计数器，否则就会产生系统复位，当上限值小于下限值，也没有意义。

最后，拓展一下[**基于STM32、FreeRTOS实现硬件看门狗+软件看门狗监测多任务的思路**](http://mp.weixin.qq.com/s?__biz=MzI4MDI4MDE5Ng%3D%3D&chksm=ebb85472dccfdd6459c648f0f5971f029227a7a50a23dafe3e015ca1aa1f9ea5a17cbd0f6f26&idx=1&mid=2247498137&scene=21&sn=c6d6c1624b37951b857f41bcb9969660#wechat_redirect)。

# 基于STM32、FreeRTOS实现硬件看门狗+软件看门狗监测多任务的思路

我们都知道硬件看门狗的目的：**是用来监测系统，防止系统死机，并在死机的情况下使其系统复位重启。**



在RTOS操作系统中，如果任务（线程）较多，出现高优先级任务长时间占用CPU资源，低优先级任务长时间得不到执行这种想象，那么我们的系统就是具有“Bug”的系统。



如上描述，假如我们的线程没有死机，只是长时间得不到执行。在这种异常情况下，我们又不希望系统复位，只希望执行特定代码，那我们该如何来避免这种问题呢？ 

**关于看门狗**

**硬件看门狗**：利用一个定时器计数电路，其定时输出连接到电路的复位端，程序在一定时间范围内对定时“喂狗”。



因此程序正常工作时，定时器总不能溢出，也就不能产生复位信号。如果程序出现故障，不在定时周期内喂狗，就使得看门狗定时器溢出产生复位信号并重启系统。



在STM32中，有两个看门狗：独立看门狗和窗口看门狗。原理和功能都类似，只是应用场景不一样。



**软件看门狗**：软件看门狗和硬件看门狗原理类似，都是定期（在时间溢出之内），对其喂狗。只是软件喂狗的方式是通过自身设计的计数来实现。

**硬件+软件看门狗监测多任务的原理**

1.利用一个监测线程（自身），来监测其它多个线程；

2.利用硬件看门狗来监测自身。



如图：

![图片](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310310951801.jpeg)



假如我系统中有多个应用线程（如上图），我就利用一个监测线程（自身），来监测其它多个应用线程。



同时，为了防止自身线程异常，利用一个硬件看门狗来监测自身。这样就可以做到双重监测的作用。

**结合软件来讲原理**

上一节上述的原理可能对于有些人来说，是比较抽象的。那么这一节来看看代码：



**监测线程（自身）**：

![图片](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310310951276.jpeg)



简单来说：在监测线程（自身）之中，需要对硬件看门狗进行喂狗。软件看门狗的角色：在这里就是对齐计数，浏览是否溢出，我把它封装成一个浏览函数。具体的喂狗就在其他各个被监测的线程中。



那么，再看软件看门狗对其中一个应用线程喂狗的代码：

![图片](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310310951282.jpeg)

这里只是简单的举例，一个主线程里面的喂狗。相当于：我线程启动之后，就需要定时喂狗。如果这里长时间不喂狗，那么**监测线程（自身）**就会发现你没有喂狗。

**简答的实现方法**

看到这里，相信大家都知道其原理了。具体实现的方式方法很多种，可根据自己实际项目需要，添加相应的接口。这里举例几点吧。



定义一个数据结构：

![图片](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310310951174.jpeg)

这里举例，是实现最基础的东西，比如计数器，最大超时值等。



注册接口函数：

![图片](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310310951162.jpeg)



监测浏览函数接口：

![图片](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202310310951182.jpeg)



以上只是教大家方法，具体的实现，可自己根据自己习惯，项目需求来定制化开发。