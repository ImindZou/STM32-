# 基于HAL库 STM32中断详述



> 闲来无事，没事找事。周三啊，没课的下午真是惬意，找点事情干干，早上在床上没事翻了翻老师的课程介绍，老师是一位从事STM32教学的高级教师，经验丰富，观看了一下视频之后，觉得讲得挺不错的，还有配套资料，正好昨晚写了一篇STM32关于HAL库跟标准库区别的文章，突然就灵光乍现，想着也把HAL库过一遍，HAL库牛逼。👍👍👍于是就有了这篇文章了。

![马斯克一周身家暴增78亿美元 成全球第四大富豪 _新闻_新出行](https://ts1.cn.mm.bing.net/th/id/R-C.ce5a3543b1bbc300affb77e8fa9921da?rik=OFGwUqi80VrB4A&riu=http%3a%2f%2fs3.xchuxing.com%2fxchuxing%2farticle%2f2020%2f08%2f18%2f3fec6202008181354233951.jpg&ehk=LnLSQRdJvytEAvIDuwD29puM61CIZzGF1AgQEdNYufg%3d&risl=&pid=ImgRaw&r=0)

> **每日一句：**💃💃💃
>
> **Some people don't like change, but if the alternative is disaster, you need to embrace change.**
>
> **————有些人不喜欢变化，但如果另一个选择是灾难，你需要拥抱变化。**

> 首先要弄明白一个东西的前提是明白，这个东西的概念，只有弄清楚了概念我们才清楚这个东西是什么，这样至少我们有了一个确定的方向可以为止前进，努力。开始我们的概述吧。

## 中断概述

中断是指处理器在执行某一程序的过程中，由于处理器系统内外的某种原因，而**终止原程序**的执行，转而去执行中断程序，待处理结束后，再回来原位置继续执行被终止原程序的过程。

> ————中断时处理器处理**外部突发事件**的一个重要技术。

## 关于STM32的中断

几乎如何一款单片机都会有中断。以STM32F103C8T6来说，这是一款基于Corte-M3内核的芯片，在CM3内核中有关于中断的一些管理，在STM32芯片中也有关于中断的一些管理。因此可以总结出一条规律，STM32的中断是由两层控制器分别控制的，**如果你想使用中断，那么必须同时配置内核和芯片**。

## STM32中断概述

> **STM32F103的系统异常中断有8个(如果把Rest和HardFault也算上的话就是10个)。**
>
> **STM32F103外部中断有60个。**

![image-20230927184300256](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309271843347.png)

## STM32的中断和异常

![image-20230927184725091](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309271847162.png)

> 从内核架构图可以看到，NVIC控制器用来管理内核中的中断。内核对中断的控制主要表现为几个方面：**中断地址、中断优先级、中断使能。**

## NVIC简介

> **NVIC**英文全称：**Nested Vectored Interrupt Controller**，中文意思为**嵌套向量中断控制器**。

STM32支持16级优先级，使用4位表示，分组方式如下：

![image-20230927185414966](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309271854018.png)

- NVIC的中断优先级由优先级寄存器的4位（0~15）决定，这4位可以进行切分，分为高n位的抢占优先级和低4~n位的响应优先级
- 抢占优先级高的可以中断嵌套，响应优先级高的可以优先排队，抢占优先级和响应优先级均相同的按中断号排队。

![image-20230927185958455](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309271859542.png)



设置抢占优先级默认为第四组。

## STM32中断/事件控制器（EXTI）

外部中断/事件控制器包含20个边沿检测器，用于产生中断/事件请求。每个中断线都可以独立地配置它的触发事件（上升沿或下降沿或双边沿），并能单独地被屏蔽；由一个挂起寄存器维持所有中断请求的状态。EXTI可以检测到脉冲宽度小于APB2的时钟周期。多大80个通用I/O口了解到16个外部中断线。

外部信号进入经过 **1 边沿检测电路**，根据需要的边沿检测设置**2个触发寄存器**（由 2 和 3 的上升沿和下建议选择寄存器决定），产生信号，然后和 **4 软件中断事件寄存器或值**（在这里可以说就是写入软件中断事件寄存器模拟中断和事件），之后产生信号一分为二，**看 5 请求挂起寄存器和 7 事件屏蔽寄存器**，如果终端和时间都没有屏蔽，首先会产生事件，进入脉冲发生器。其次，**会进入 6 中断屏蔽寄存器**，然后进入NVIC。

![image-20230927191037306](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309271910360.png)

从事ST MCU应用开发的人往往会遇到**事件、中断事件、中断**三个概念或术语。这三个概念彼此关联，有时会让人有点混淆或犯迷糊。

> 先拿一件生活中的事情打比方对上述三个概念做个基本粗略的理解，之后在分享一个STM32 GPIO外部中断配置案例。

<u>比如</u>：一个老师在教室里给学生上课。课堂上的学生可能做出各种行为动作，比方说做笔记、打哈欠、翻书包、讲小话等，我们把这些行为统称为**事件**，其中有些行为老师往往只是视而不见，继续上他的课；而有的行为可能导致老师的上课中止，比方说讲小话，并对学生的相关行为予以警告、批评或纠正等，然后继续上课。我们把老师因为学生的某些行为而中止授课，并产生后续动作的这个过程理解为**中断或中断响应**。我们把可能导致老师上课中断的学生行为理解为**中断事件**。

结合上面的比方，不难理解**中断事件**时一种可以导致中断发生的事件，**中断**则是因为中断事件的发生而导致的后续行为过程。**事件与中断事件是包含关系**，即事件可分为中断事件或非中断事件。**而中断事件与中断之间属于前后关联的因果关系，虽有关联，但二者在是时序上、行为上并不一样。**

结合具体的STM MCU运行过程，其中会有许多各种各样的**事件**，比方管脚电平变化、计数器溢出、

DMA空、FIFO非空、AD转换结束、超时、外设使能、初始化等等，<u>其中有些事件就可能导致中断发生，比方说计数器溢出，AD转换结束等，这些就是**中断事件**</u>。

当然这些中断事件最终能否触发后续中断，得看是否开启了中断事件的中断使能，相关中断矢量控制器【NVIC】是否配置，最终让CPU内核参与进来，并完成后续的中断服务动作。

## STM32 外部中断/事件控制器

STM32 的每个I/O都可以作为外部中断输入口。普通I/O口作为中断使用时需要指定中断线，即EXTI接口。

![image-20230927203734414](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309272037493.png)

- 总结就是：
    - 尾号相同的引脚一组，接入一个外部中断线，同组引脚只能有一个设置为外部中断功能。
    - EXTI 0~4 分别具有独立的中断通道，EXTI 5~9 共享一个中断通道，EXTI 10~15共享一个中断通道。



## HAL库对中断的封装处理

**启动文件中的中断向量表：**

![image-20230927204407230](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309272044316.png)

PB1引脚使能外部中断后，如果发生中断就会跳转到对应的中断服务程序 **void EXTI1_IRQHandler(void)**（外部中断线 1 的中断服务程序，该程序在STM32f1xx_it.c文件中）。

**如图所示——》**中断服务程序调用外部中断通用处理函数  HAL_GPIO_EXTI_IRQHandler(EXIT_KEY_Toggle_Pin);

![image-20230927205147944](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309272051999.png)

外部中断函数  **void HAL_GPIO_EXTI_IRQHandler(uint16_t GPIO_Pin)**  在STM32f1xx_hal_gpio.c文件中。在该函数内部，先检测中断标志位，如果中断标志位置位，则清楚中断标志位，然后调用回调函数，完成具体中断处理任务。

![image-20230927205718632](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309272057692.png)

![image-20230927210029639](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309272100683.png)

**中断标志位在手册儿里边的说明：**

![image-20230927210046566](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309272100624.png)

## 总结外部中断的处理流程如下：

![image-20230927210921330](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309272109385.png)

## 实施阶段建立工程生成代码（以高电平驱动LED灯为例）

![image-20230927211409899](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309272114988.png)

![image-20230927211447157](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309272114222.png)



## 生成初始化代码——》完善代码

**定义按键状态变量：在mian.c中定义：**

![image-20230927211558402](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309272115437.png)

**编写回调函数：**

![image-20230927211703214](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309272117259.png)

**编写主函数：**

![image-20230927211735629](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309272117671.png)

**生成.hex——》烧录——》查看现象**

![EXTI](https://zdh934.oss-cn-shenzhen.aliyuncs.com/PigGo/202309272121358.gif)

> 至此结束：感谢你能看到这里👻👻👻，有什么不足之处欢迎评论区留言，我会根据意见进一步改进
>
> 回忆一下文章开头的话：
>
> **Some people don't like change, but if the alternative is disaster, you need to embrace change.**
>
> **————有些人不喜欢变化，但如果另一个选择是灾难，你需要拥抱变化。**
>
> **致共同进步的你**



